tinymce.PluginManager.add("solire_image",function(d){function c(g,i){var f=document.createElement("img"),h;function e(k,j){f.parentNode.removeChild(f);i({width:k,height:j})}f.onload=function(){e(f.clientWidth,f.clientHeight)};f.onerror=function(){e()};f.src=g;h=f.style;h.visibility="hidden";h.position="fixed";h.bottom=h.left=0;h.width=h.height="auto";document.body.appendChild(f)}function b(e){return function(){var f=d.settings.image_list;if(typeof(f)=="string"){tinymce.util.XHR.send({url:f,success:function(g){e(tinymce.util.JSON.parse(g))}})}else{e(f)}}}function a(g){var n,l,e,q,o,f,k=d.dom,m=d.selection.getNode();function p(){var t=[{text:"Choisir une image",value:""}];tinymce.each(g,function(u){t.push({text:u.text||u.title,value:u.value||u.url,menu:u.menu})});return t}function i(x){var u,w,v,t;u=n.find("#width")[0];w=n.find("#height")[0];v=u.value();t=w.value();if(n.find("#constrain")[0].checked()&&e&&q&&v&&t){if(x.control==u){t=Math.round((v/e)*t);w.value(t)}else{v=Math.round((t/q)*v);u.value(v)}}e=v;q=t}function j(){function t(w){function v(){w.onload=w.onerror=null;d.selection.select(w);d.nodeChanged()}w.onload=function(){if(!u.width&&!u.height){k.setAttribs(w,{width:w.clientWidth,height:w.clientHeight})}v()};w.onerror=v}var u=n.toJSON();if(u.width===""){u.width=null}if(u.height===""){u.height=null}if(u.style===""){u.style=null}u={src:u.src,alt:u.alt,width:u.width,height:u.height,style:u.style};d.undoManager.transact(function(){if(!u.src){if(m){k.remove(m);d.nodeChanged()}return}if(!m){u.id="__mcenew";d.selection.setContent(k.createHTML("img",u));m=k.get("__mcenew");k.setAttrib(m,"id",null)}else{k.setAttribs(m,u)}t(m)})}function s(t){if(t){t=t.replace(/px$/,"")}return t}function h(){c(this.value(),function(t){if(t.width&&t.height){e=t.width;q=t.height;n.find("#width").value(e);n.find("#height").value(q)}})}e=k.getAttrib(m,"width");q=k.getAttrib(m,"height");if(m.nodeName=="IMG"&&!m.getAttribute("data-mce-object")){l={src:k.getAttrib(m,"src"),alt:k.getAttrib(m,"alt"),width:e,height:q}}else{m=null}if(g){o={name:"target",type:"listbox",label:"Image list",values:p(),onselect:function(t){var u=n.find("#alt");if(!u.value()||(t.lastControl&&u.value()==t.lastControl.text())){u.value(t.control.text())}n.find("#src").value(t.control.value())}}}f=[{name:"src",type:"filepicker",filetype:"image",label:"Source",autofocus:true,onchange:h},o,{name:"alt",type:"textbox",label:"Image description"},{type:"container",label:"Dimensions",layout:"flex",direction:"row",align:"center",spacing:5,items:[{name:"width",type:"textbox",maxLength:3,size:3,onchange:i},{type:"label",text:"x"},{name:"height",type:"textbox",maxLength:3,size:3,onchange:i},{name:"constrain",type:"checkbox",checked:true,text:"Constrain proportions"}]}];function r(){function v(w){if(w.length>0&&/^[0-9]+$/.test(w)){w+="px"}return w}var u=n.toJSON(),t=k.parseStyle(u.style);k.setAttrib(m,"style","");delete t.margin;t["margin-top"]=t["margin-bottom"]=v(u.vspace);t["margin-left"]=t["margin-right"]=v(u.hspace);t["border-width"]=v(u.border);n.find("#style").value(k.serializeStyle(k.parseStyle(k.serializeStyle(t))))}if(d.settings.image_advtab){if(m){l.hspace=s(m.style.marginLeft||m.style.marginRight);l.vspace=s(m.style.marginTop||m.style.marginBottom);l.border=s(m.style.borderWidth);l.style=d.dom.serializeStyle(d.dom.parseStyle(d.dom.getAttrib(m,"style")))}n=d.windowManager.open({title:"Insert/edit image",data:l,bodyType:"tabpanel",body:[{title:"General",type:"form",items:f},{title:"Advanced",type:"form",pack:"start",items:[{label:"Style",name:"style",type:"textbox"},{type:"form",layout:"grid",packV:"start",columns:2,padding:0,alignH:["left","right"],defaults:{type:"textbox",maxWidth:50,onchange:r},items:[{label:"Vertical space",name:"vspace"},{label:"Horizontal space",name:"hspace"},{label:"Border",name:"border"}]}]}],onSubmit:j})}else{n=d.windowManager.open({title:"Insert/edit image",data:l,body:f,onSubmit:j})}}d.addButton("solire_image",{icon:"image",tooltip:"Insert/edit image",onclick:b(a),stateSelector:"img:not([data-mce-object])"});d.addMenuItem("solire_image",{icon:"image",text:"Insert image",onclick:b(a),context:"insert",prependToContext:true})});