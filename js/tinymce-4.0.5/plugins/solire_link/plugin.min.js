tinymce.PluginManager.add("solire_link",function(c){function b(d){return function(){var e=c.settings.link_list;if(typeof(e)=="string"){tinymce.util.XHR.send({url:e,success:function(f){d(tinymce.util.JSON.parse(f))}})}else{d(e)}}}function a(s){var j={},m=c.selection,i=c.dom,f,t,p,k,l,h,d;function g(u){var v=k.find("#text");if(!v.value()||(u.lastControl&&v.value()==u.lastControl.text())){v.value(u.control.text())}k.find("#href").value(u.control.value())}function o(){var u=[{text:"Choisir un lien",value:""}];tinymce.each(s,function(v){u.push({text:v.text||v.title,value:v.value||v.url,menu:v.menu})});return u}function r(u){var v=[{text:"None",value:""}];tinymce.each(c.settings.rel_list,function(w){v.push({text:w.text||w.title,value:w.value,selected:u===w.value})});return v}function q(v){var u=[{text:"None",value:""}];if(!c.settings.target_list){u.push({text:"New window",value:"_blank"})}tinymce.each(c.settings.target_list,function(w){u.push({text:w.text||w.title,value:w.value,selected:v===w.value})});return u}function n(u){var v=[];tinymce.each(c.dom.select("a:not([href])"),function(w){var x=w.name||w.id;if(x){v.push({text:x,value:"#"+x,selected:u.indexOf("#"+x)!=-1})}});if(v.length){v.unshift({text:"None",value:""});return{name:"anchor",type:"listbox",label:"Anchors",values:v,onselect:g}}}function e(){if(!p&&j.text.length===0){this.parent().parent().find("#text")[0].value(this.value())}}f=m.getNode();t=i.getParent(f,"a[href]");j.text=p=t?(t.innerText||t.textContent):m.getContent({format:"text"});j.href=t?i.getAttrib(t,"href"):"";j.target=t?i.getAttrib(t,"target"):"";j.rel=t?i.getAttrib(t,"rel"):"";if(f.nodeName=="IMG"){j.text=p=" "}if(s){l={type:"listbox",label:"Link list",values:o(),onselect:g}}if(c.settings.target_list!==false){d={name:"target",type:"listbox",label:"Target",values:q(j.target)}}if(c.settings.rel_list){h={name:"rel",type:"listbox",label:"Rel",values:r(j.rel)}}k=c.windowManager.open({title:"Insert link",data:j,body:[{name:"href",type:"filepicker",filetype:"file",size:40,autofocus:true,label:"Url",onchange:e,onkeyup:e},{autofocus:true,name:"text",type:"textbox",size:40,label:"Text to display",onchange:function(){j.text=this.value()}},n(j.href),l,h,d],onSubmit:function(y){var x=y.data,u=x.href;function w(z,A){window.setTimeout(function(){c.windowManager.confirm(z,A)},0)}function v(){if(x.text!=p){if(t){c.focus();t.innerHTML=x.text;i.setAttribs(t,{href:u,target:x.target?x.target:null,rel:x.rel?x.rel:null});m.select(t)}else{c.insertContent(i.createHTML("a",{href:u,target:x.target?x.target:null,rel:x.rel?x.rel:null},x.text))}}else{c.execCommand("mceInsertLink",false,{href:u,target:x.target,rel:x.rel?x.rel:null})}}if(!u){c.execCommand("unlink");return}if(u.indexOf("@")>0&&u.indexOf("//")==-1&&u.indexOf("mailto:")==-1){w("The URL you entered seems to be an email address. Do you want to add the required mailto: prefix?",function(z){if(z){u="mailto:"+u}v()});return}if(/^\s*www\./i.test(u)){w("The URL you entered seems to be an external link. Do you want to add the required http:// prefix?",function(z){if(z){u="http://"+u}v()});return}v()}})}c.addButton("solire_link",{icon:"link",tooltip:"Insert/edit link",shortcut:"Ctrl+K",onclick:b(a),stateSelector:"a[href]"});c.addButton("solire_unlink",{icon:"unlink",tooltip:"Remove link",cmd:"unlink",stateSelector:"a[href]"});c.addShortcut("Ctrl+K","",b(a));this.showDialog=a;c.addMenuItem("link",{icon:"link",text:"Insert link",shortcut:"Ctrl+K",onclick:b(a),stateSelector:"a[href]",context:"insert",prependToContext:true})});